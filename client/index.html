<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mobile-optimized dashboard for managing Sant Padharamani services">
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sant Padharamani">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Sant Padharamani - Dashboard</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle cx='96' cy='96' r='86' fill='%23f97316'/%3E%3Ctext x='96' y='115' text-anchor='middle' fill='white' font-size='76' font-family='Arial, sans-serif'%3ESP%3C/text%3E%3C/svg%3E">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23f97316'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-family='Arial, sans-serif'%3ESP%3C/text%3E%3C/svg%3E">
    
    <!-- Tailwind CSS - Using CDN for development -->
    <script>
        // Suppress Tailwind CDN warning in development
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                        },
                        secondary: {
                            50: '#f0f9ff',
                            500: '#0ea5e9',
                            600: '#0284c7',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --primary-color: #f97316;
            --primary-dark: #ea580c;
            --primary-light: #fed7aa;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            padding-bottom: calc(80px + var(--safe-area-bottom));
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .card-shadow:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Mobile-first webapp styles */
        .mobile-card {
            margin-bottom: 1rem;
        }
        
        .mobile-button {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
            -webkit-touch-callout: none;
        }
        
        .mobile-input {
            min-height: 44px;
            font-size: 16px;
            -webkit-appearance: none;
            border-radius: 8px;
        }
        
        .mobile-modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        /* Bottom Navigation Styles */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px 0;
            padding-bottom: calc(8px + var(--safe-area-bottom));
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .bottom-nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            min-width: 60px;
            min-height: 44px;
            text-decoration: none;
            color: #6b7280;
            transition: all 0.2s ease-in-out;
            border-radius: 12px;
            touch-action: manipulation;
        }
        
        .bottom-nav-item:hover {
            background-color: #f3f4f6;
        }
        
        .bottom-nav-item.active {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        .bottom-nav-item.active .bottom-nav-icon {
            fill: var(--primary-color);
        }
        
        .bottom-nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
            fill: currentColor;
        }
        
        .bottom-nav-label {
            font-size: 10px;
            font-weight: 500;
            line-height: 1.2;
        }
        
        /* Hide top navigation on mobile */
        .top-nav {
            display: none;
        }
        
        @media (min-width: 768px) {
            .bottom-nav {
                display: none;
            }
            .top-nav {
                display: block;
            }
            body {
                padding-bottom: 0;
            }
        }
        
        /* Phone number validation styles */
        .phone-error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .phone-valid {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        
        /* Address link styles */
        .address-link {
            color: #2563eb;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .address-link:hover {
            color: #1d4ed8;
        }
        
        /* Telegram styles */
        .telegram-button {
            background: linear-gradient(135deg, #0088cc, #005580);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .telegram-button:hover {
            background: linear-gradient(135deg, #005580, #003d5a);
        }
        
        /* Telegram Mini App styles */
        .telegram-mini-app {
            min-height: 100vh;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        .telegram-header {
            background: var(--tg-theme-secondary-bg-color, #f1f3f4);
            color: var(--tg-theme-text-color, #000000);
        }
        
        /* PWA enhancements */
        .install-prompt {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            z-index: 1001;
            display: none;
        }
        
        /* Improved scrolling */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- React Components -->
    <script type="text/babel">
        console.log('🚀 client/index.html: Script started, initializing React app...');
        console.log('📋 Environment check:', {
            userAgent: navigator.userAgent,
            url: window.location.href,
            timestamp: new Date().toISOString(),
            reactLoaded: typeof React !== 'undefined',
            reactDOMLoaded: typeof ReactDOM !== 'undefined',
            babelLoaded: typeof Babel !== 'undefined'
        });
        
        const { useState, useEffect, useRef } = React;
        
        // Telegram WebApp initialization
        const initTelegramWebApp = () => {
            console.log('📱 Telegram WebApp initialization started...');
            if (typeof window !== 'undefined' && window.Telegram && window.Telegram.WebApp) {
                console.log('✅ Telegram WebApp detected, initializing...');
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                console.log('📱 Telegram WebApp initialized:', {
                    version: tg.version,
                    platform: tg.platform,
                    colorScheme: tg.colorScheme,
                    themeParams: tg.themeParams,
                    initData: tg.initData ? 'Present' : 'Not available'
                });
                
                // Apply Telegram theme
                console.log('🎨 Applying Telegram theme...');
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f1f3f4');
                
                return tg;
            } else {
                console.log('❌ Telegram WebApp not available (normal browser mode)');
            }
            return null;
        };
        
        // Get Telegram user data
        const getTelegramUser = () => {
            console.log('👤 Getting Telegram user data...');
            const tg = window.Telegram?.WebApp;
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const userData = {
                    id: tg.initDataUnsafe.user.id,
                    first_name: tg.initDataUnsafe.user.first_name,
                    last_name: tg.initDataUnsafe.user.last_name,
                    username: tg.initDataUnsafe.user.username,
                    language_code: tg.initDataUnsafe.user.language_code,
                    is_premium: tg.initDataUnsafe.user.is_premium
                };
                console.log('✅ Telegram user data retrieved:', userData);
                return userData;
            } else {
                console.log('❌ No Telegram user data available');
            }
            return null;
        };

        // API utility functions
        const API_BASE = '/api';
        console.log('🌐 API base URL configured:', API_BASE);

        const api = {
            get: async (endpoint) => {
                console.log(`🔍 API GET request to: ${API_BASE}${endpoint}`);
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        }
                    });
                    console.log(`📡 GET ${endpoint} response:`, {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('🔐 Unauthorized, removing token and redirecting to login');
                            localStorage.removeItem('token');
                            window.location.href = '/auth/login-page';
                            throw new Error('Authentication required');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log(`✅ GET ${endpoint} success, data:`, data);
                    return data;
                } catch (error) {
                    console.error(`❌ API GET ${endpoint} failed:`, error);
                    throw error;
                }
            },

            post: async (endpoint, data) => {
                console.log(`📤 API POST request to: ${API_BASE}${endpoint}`, data);
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        },
                        body: JSON.stringify(data)
                    });
                    console.log(`📡 POST ${endpoint} response:`, {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('🔐 Unauthorized, removing token and redirecting to login');
                            localStorage.removeItem('token');
                            window.location.href = '/auth/login-page';
                            throw new Error('Authentication required');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    console.log(`✅ POST ${endpoint} success, data:`, responseData);
                    return responseData;
                } catch (error) {
                    console.error(`❌ API POST ${endpoint} failed:`, error);
                    throw error;
                }
            },

            put: async (endpoint, data) => {
                console.log(`📝 API PUT request to: ${API_BASE}${endpoint}`, data);
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        },
                        body: JSON.stringify(data)
                    });
                    console.log(`📡 PUT ${endpoint} response:`, {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('🔐 Unauthorized, removing token and redirecting to login');
                            localStorage.removeItem('token');
                            window.location.href = '/auth/login-page';
                            throw new Error('Authentication required');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    console.log(`✅ PUT ${endpoint} success, data:`, responseData);
                    return responseData;
                } catch (error) {
                    console.error(`❌ API PUT ${endpoint} failed:`, error);
                    throw error;
                }
            }
        };

        // Navigation Component
        const Navigation = ({ currentPage, onPageChange, user, onLogout }) => {
            const bottomNavItems = [
                { 
                    key: 'upcoming', 
                    label: 'Upcoming', 
                    icon: (active) => (
                        <svg className="bottom-nav-icon" viewBox="0 0 24 24" fill={active ? "currentColor" : "none"} stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    )
                },
                { 
                    key: 'scheduled', 
                    label: 'Requests', 
                    icon: (active) => (
                        <svg className="bottom-nav-icon" viewBox="0 0 24 24" fill={active ? "currentColor" : "none"} stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    )
                },
                { 
                    key: 'add', 
                    label: 'Add', 
                    icon: (active) => (
                        <svg className="bottom-nav-icon" viewBox="0 0 24 24" fill={active ? "currentColor" : "none"} stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    )
                },
                { 
                    key: 'archived', 
                    label: 'Archive', 
                    icon: (active) => (
                        <svg className="bottom-nav-icon" viewBox="0 0 24 24" fill={active ? "currentColor" : "none"} stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 8l6 6M5 8l6-6m0 12L5 8l6-6m0 12l6-6m-6 6V2" />
                        </svg>
                    )
                },
                { 
                    key: 'settings', 
                    label: 'More', 
                    icon: (active) => (
                        <svg className="bottom-nav-icon" viewBox="0 0 24 24" fill={active ? "currentColor" : "none"} stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                    )
                }
            ];
            
            return (
                <>
                    {/* Top Navigation (Desktop) */}
                    <nav className="top-nav gradient-bg shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center">
                                    <h1 className="text-white text-xl font-bold text-center">Sant Padharamani Dashboard</h1>
                                </div>
                                
                                <div className="flex items-center space-x-4">
                                    {bottomNavItems.slice(0, 4).map(item => (
                                        <button
                                            key={item.key}
                                            onClick={() => onPageChange(item.key)}
                                            className={`px-3 py-2 rounded-md text-sm font-medium transition-colors mobile-button ${
                                                currentPage === item.key 
                                                    ? 'bg-white bg-opacity-20 text-white' 
                                                    : 'text-orange-100 hover:bg-white hover:bg-opacity-10 hover:text-white'
                                            }`}
                                        >
                                            {item.label}
                                        </button>
                                    ))}
                                    {user && (
                                        <div className="flex items-center space-x-2 ml-4">
                                            <span className="text-orange-100 text-sm">{user.name}</span>
                                            <button
                                                onClick={onLogout}
                                                className="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors mobile-button"
                                            >
                                                Logout
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    {/* Bottom Navigation (Mobile) */}
                    <div className="bottom-nav">
                        <div className="bottom-nav-container">
                            {bottomNavItems.map(item => (
                                <button
                                    key={item.key}
                                    onClick={() => onPageChange(item.key)}
                                    className={`bottom-nav-item ${currentPage === item.key ? 'active' : ''}`}
                                >
                                    {item.icon(currentPage === item.key)}
                                    <span className="bottom-nav-label">{item.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </>
            );
        };

        // Padharamani Card Component
        const PadharamaniCard = ({ padharamani, onEdit, onCancel, onActivate, showActions = true }) => {
            const formatTime = (time) => {
                if (!time) return 'Not set';
                return time.length === 5 ? time : time.substring(0, 5);
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return 'Date not set';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            };

            const copyToClipboard = () => {
                const text = `Padharamani Details:
Date: ${formatDate(padharamani.date)}
Time: ${formatTime(padharamani.beginningTime)} - ${formatTime(padharamani.endingTime)}
Name: ${padharamani.name}
Phone: ${padharamani.phone}
Address: ${padharamani.address}, ${padharamani.city}
Transport Volunteer: ${padharamani.transportVolunteer || 'Not assigned'}
Transport Volunteer's Phone: ${padharamani.volunteerNumber || 'Not provided'}
Zone Coordinator: ${padharamani.zoneCoordinator || 'Not assigned'}
Coordinator Phone: ${padharamani.zoneCoordinatorPhone || 'Not provided'}${padharamani.email ? `
Email: ${padharamani.email}` : ''}
Comments: ${padharamani.comments || 'None'}`;

                navigator.clipboard.writeText(text).then(() => {
                    alert('Details copied to clipboard!');
                });
            };

            return (
                <div className={`bg-white rounded-lg card-shadow p-4 sm:p-6 mb-4 transition-all mobile-card ${
                    padharamani.status === 'Canceled' ? 'opacity-60 bg-red-50' : ''
                }`}>
                    {padharamani.status === 'Canceled' && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
                            <strong>CANCELED</strong>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div>
                            <h3 className="text-lg font-semibold text-gray-900 mb-2">{padharamani.name || 'Name not provided'}</h3>
                            <div className="space-y-1">
                                <p className="text-sm text-gray-600">
                                    <span className="font-medium">Date:</span> {formatDate(padharamani.date)}
                                </p>
                                <p className="text-sm text-gray-600">
                                    <span className="font-medium">Time:</span> {formatTime(padharamani.beginningTime)} - {formatTime(padharamani.endingTime)}
                                </p>
                                <p className="text-sm text-gray-600">
                                    <span className="font-medium">Phone:</span> 
                                    {padharamani.phone ? (
                                        <a href={`tel:${padharamani.phone}`} className="text-blue-600 hover:underline ml-1">
                                            {formatPhone(padharamani.phone)}
                                        </a>
                                    ) : ' Not provided'}
                                </p>
                                {padharamani.email && (
                                    <p className="text-sm text-gray-600">
                                        <span className="font-medium">Email:</span> {padharamani.email}
                                    </p>
                                )}
                            </div>
                        </div>
                        
                        <div>
                            <div className="space-y-1">
                                <p className="text-sm text-gray-600">
                                    <span className="font-medium">Address:</span> 
                                    {padharamani.address ? (
                                        <a 
                                            href={`https://maps.google.com/?q=${encodeURIComponent(padharamani.address + ', ' + (padharamani.city || ''))}`}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="address-link ml-1"
                                        >
                                            {padharamani.address}
                                        </a>
                                    ) : ' Not provided'}
                                </p>
                                <p className="text-sm text-gray-600">
                                    <span className="font-medium">City:</span> {padharamani.city || 'Not provided'}
                                </p>
                                {(padharamani.transportVolunteer || padharamani.volunteerNumber) && (
                                    <>
                                        {padharamani.transportVolunteer && (
                                            <p className="text-sm text-gray-600">
                                                <span className="font-medium">Transport Volunteer:</span> {padharamani.transportVolunteer}
                                            </p>
                                        )}
                                        {padharamani.volunteerNumber && (
                                            <p className="text-sm text-gray-600">
                                                <span className="font-medium">Transport Volunteer's Phone:</span> 
                                                <a href={`tel:${padharamani.volunteerNumber}`} className="text-blue-600 hover:underline ml-1">
                                                    {formatPhone(padharamani.volunteerNumber)}
                                                </a>
                                            </p>
                                        )}
                                    </>
                                )}
                                {(padharamani.zoneCoordinator || padharamani.zoneCoordinatorPhone) && (
                                    <>
                                        {padharamani.zoneCoordinator && (
                                            <p className="text-sm text-gray-600">
                                                <span className="font-medium">Zone Coordinator:</span> {padharamani.zoneCoordinator}
                                            </p>
                                        )}
                                        {padharamani.zoneCoordinatorPhone && (
                                            <p className="text-sm text-gray-600">
                                                <span className="font-medium">Coordinator Phone:</span>
                                                <a href={`tel:${padharamani.zoneCoordinatorPhone}`} className="text-blue-600 hover:underline ml-1">
                                                    {formatPhone(padharamani.zoneCoordinatorPhone)}
                                                </a>
                                            </p>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {padharamani.comments && (
                        <div className="mt-4">
                            <p className="text-sm text-gray-600">
                                <span className="font-medium">Comments:</span> {padharamani.comments}
                            </p>
                        </div>
                    )}
                    
                    {showActions && (
                        <div className="mt-4 flex flex-wrap gap-2">
                            <button
                                onClick={copyToClipboard}
                                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors mobile-button"
                            >
                                Copy
                            </button>
                            {padharamani.status === 'Canceled' ? (
                                <button
                                    onClick={() => onActivate(padharamani)}
                                    className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors mobile-button"
                                >
                                    Activate
                                </button>
                            ) : (
                                <>
                                    <button
                                        onClick={() => onEdit(padharamani)}
                                        className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors mobile-button"
                                    >
                                        Edit
                                    </button>
                                    <button
                                        onClick={() => onCancel(padharamani)}
                                        className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors mobile-button"
                                    >
                                        Cancel
                                    </button>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // Phone validation utility
        const validatePhone = (phone) => {
            const cleanPhone = phone.replace(/\D/g, ''); // Remove non-digits
            return cleanPhone.length === 10;
        };

        // Format phone for display (adds hyphens)
        const formatPhone = (phone) => {
            const cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.length === 10) {
                return `${cleanPhone.slice(0, 3)}-${cleanPhone.slice(3, 6)}-${cleanPhone.slice(6)}`;
            }
            return phone;
        };

        // Form Input Component with phone validation
        const FormInput = ({ label, type = 'text', value, onChange, required = false, ...props }) => {
            const [phoneError, setPhoneError] = useState('');
            
            const handlePhoneChange = (newValue) => {
                onChange(newValue);
                if (type === 'tel' && newValue) {
                    if (!validatePhone(newValue)) {
                        setPhoneError('Phone number must be exactly 10 digits');
                    } else {
                        setPhoneError('');
                    }
                } else {
                    setPhoneError('');
                }
            };
            
            return (
                <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                        {label} {required && <span className="text-red-500">*</span>}
                    </label>
                    <input
                        type={type}
                        value={value || ''}
                        onChange={(e) => type === 'tel' ? handlePhoneChange(e.target.value) : onChange(e.target.value)}
                        required={required}
                        className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 mobile-input ${
                            type === 'tel' && value && phoneError ? 'phone-error' : type === 'tel' && value && validatePhone(value) ? 'phone-valid' : 'border-gray-300'
                        }`}
                        {...props}
                    />
                    {type === 'tel' && phoneError && (
                        <p className="text-red-500 text-xs mt-1">{phoneError}</p>
                    )}
                </div>
            )
        };

        // Upcoming Padharamani Page
        const UpcomingPage = ({ onEdit, onCancel, onActivate }) => {
            const [padharamanis, setPadharamanis] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isLoadingRef, setIsLoadingRef] = useState(false);

            useEffect(() => {
                console.log('🎯 UpcomingPage useEffect triggered, checking auth status...');
                // Only load data if we have a valid token
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('⚠️ No auth token found, redirecting to login...');
                    window.location.href = '/auth/login-page';
                    return;
                }
                console.log('✅ Auth token found, loading data...');
                loadUpcomingPadharamanis();
            }, []);

            const loadUpcomingPadharamanis = async () => {
                // Prevent multiple simultaneous API calls
                if (isLoadingRef) {
                    console.log('⚠️ API call already in progress, skipping...');
                    return;
                }
                
                try {
                    setIsLoadingRef(true);
                    setLoading(true);
                    setError(null); // Clear previous errors
                    console.log('🔄 Making API call to /padharamanis/upcoming');
                    const data = await api.get('/padharamanis/upcoming');
                    console.log('✅ API call successful, setting data:', data?.length, 'items');
                    setPadharamanis(data);
                } catch (err) {
                    console.error('❌ Failed to load upcoming padharamanis:', err);
                    if (err.message === 'Authentication required') {
                        console.log('🔐 Authentication required, redirecting...');
                        // Don't set error state, let redirect handle authentication
                        return;
                    }
                    setError('Failed to load upcoming padharamanis');
                } finally {
                    setLoading(false);
                    setIsLoadingRef(false);
                }
            };

            const groupByDate = (items) => {
                const groups = {};
                const today = new Date().toDateString();
                const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toDateString();

                items.forEach(item => {
                    const itemDate = new Date(item.date).toDateString();
                    let groupKey = itemDate;
                    
                    if (itemDate === today) {
                        groupKey = 'Today';
                    } else if (itemDate === tomorrow) {
                        groupKey = 'Tomorrow';
                    }
                    
                    if (!groups[groupKey]) {
                        groups[groupKey] = [];
                    }
                    groups[groupKey].push(item);
                });

                return groups;
            };

            if (loading) {
                return (
                    <div className="flex justify-center items-center h-64">
                        <div className="text-lg">Loading...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        {error}
                    </div>
                );
            }

            const groupedPadharamanis = groupByDate(padharamanis);

            return (
                <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-6">Upcoming Padharamani</h2>
                    
                    {Object.keys(groupedPadharamanis).length === 0 ? (
                        <div className="text-center py-8">
                            <p className="text-gray-500 text-lg">No upcoming padharamani scheduled</p>
                        </div>
                    ) : (
                        Object.entries(groupedPadharamanis).map(([date, items]) => (
                            <div key={date} className="mb-8">
                                <h3 className="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
                                    {date}
                                </h3>
                                {items.map((padharamani, index) => (
                                    <PadharamaniCard
                                        key={`${padharamani.date}-${index}`}
                                        padharamani={padharamani}
                                        onEdit={onEdit}
                                        onCancel={onCancel}
                                        onActivate={onActivate}
                                    />
                                ))}
                            </div>
                        ))
                    )}
                </div>
            );
        };

        // Archived Padharamani Page  
        const ArchivedPage = ({ onActivate }) => {
            const [padharamanis, setPadharamanis] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [filters, setFilters] = useState({
                startDate: '',
                endDate: '',
                name: '',
                city: ''
            });

            useEffect(() => {
                loadArchivedPadharamanis();
            }, []);

            const loadArchivedPadharamanis = async () => {
                try {
                    setLoading(true);
                    setError(null); // Clear previous errors
                    const data = await api.get('/padharamanis/archived');
                    setPadharamanis(data);
                } catch (err) {
                    console.error('❌ Failed to load archived padharamanis:', err);
                    if (err.message === 'Authentication required') {
                        // Don't set error state, let redirect handle authentication
                        return;
                    }
                    setError('Failed to load archived padharamanis');
                } finally {
                    setLoading(false);
                }
            };

            const filteredPadharamanis = padharamanis.filter(p => {
                if (filters.startDate && p.date < filters.startDate) return false;
                if (filters.endDate && p.date > filters.endDate) return false;
                if (filters.name && !p.name.toLowerCase().includes(filters.name.toLowerCase())) return false;
                if (filters.city && !p.city.toLowerCase().includes(filters.city.toLowerCase())) return false;
                return true;
            });

            if (loading) {
                return (
                    <div className="flex justify-center items-center h-64">
                        <div className="text-lg">Loading...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        {error}
                    </div>
                );
            }

            return (
                <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-6">Archived Padharamani</h2>
                    
                    {/* Filters */}
                    <div className="bg-white rounded-lg card-shadow p-6 mb-6">
                        <h3 className="text-lg font-semibold mb-4">Filters</h3>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <FormInput
                                label="Start Date"
                                type="date"
                                value={filters.startDate}
                                onChange={(value) => setFilters({...filters, startDate: value})}
                            />
                            <FormInput
                                label="End Date"
                                type="date"
                                value={filters.endDate}
                                onChange={(value) => setFilters({...filters, endDate: value})}
                            />
                            <FormInput
                                label="Name"
                                value={filters.name}
                                onChange={(value) => setFilters({...filters, name: value})}
                                placeholder="Search by name"
                            />
                            <FormInput
                                label="City"
                                value={filters.city}
                                onChange={(value) => setFilters({...filters, city: value})}
                                placeholder="Search by city"
                            />
                        </div>
                    </div>
                    
                    {filteredPadharamanis.length === 0 ? (
                        <div className="text-center py-8">
                            <p className="text-gray-500 text-lg">No archived padharamani found</p>
                        </div>
                    ) : (
                        <div>
                            {filteredPadharamanis.map((padharamani, index) => (
                                <PadharamaniCard
                                    key={`${padharamani.date}-${index}`}
                                    padharamani={padharamani}
                                    onActivate={onActivate}
                                    showActions={true}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Schedule Padharamani Page (simplified form)
        const SchedulePage = () => {
            const [formData, setFormData] = useState({
                name: '',
                address: '',
                city: '',
                email: '',
                phone: '',
                comments: ''
            });
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState(false);
            const [error, setError] = useState(null);

            const handleSubmit = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    await api.post('/padharamanis/schedule', formData);
                    
                    setSuccess(true);
                    setFormData({
                        name: '',
                        address: '',
                        city: '',
                        email: '',
                        phone: '',
                        comments: ''
                    });
                    
                    setTimeout(() => setSuccess(false), 3000);
                } catch (err) {
                    setError('Failed to schedule padharamani');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-6">Schedule a Padharamani</h2>
                    
                    {success && (
                        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                            Padharamani scheduled successfully! Details will be filled in later.
                        </div>
                    )}
                    
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                            {error}
                        </div>
                    )}
                    
                    <div className="bg-white rounded-lg card-shadow p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <FormInput
                                label="Name"
                                value={formData.name}
                                onChange={(value) => setFormData({...formData, name: value})}
                                required
                            />
                            <FormInput
                                label="Phone"
                                type="tel"
                                value={formData.phone}
                                onChange={(value) => setFormData({...formData, phone: value})}
                                required
                            />
                            <FormInput
                                label="Address"
                                value={formData.address}
                                onChange={(value) => setFormData({...formData, address: value})}
                                required
                            />
                            <FormInput
                                label="City"
                                value={formData.city}
                                onChange={(value) => setFormData({...formData, city: value})}
                                required
                            />
                            <FormInput
                                label="Email"
                                type="email"
                                value={formData.email}
                                onChange={(value) => setFormData({...formData, email: value})}
                            />
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Comments
                                </label>
                                <textarea
                                    value={formData.comments}
                                    onChange={(e) => setFormData({...formData, comments: e.target.value})}
                                    rows={3}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                />
                            </div>
                        </div>
                        
                        <div className="mt-6">
                            <button
                                onClick={handleSubmit}
                                disabled={loading || !formData.name || !formData.phone || !formData.address || !formData.city}
                                className="bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 text-white px-6 py-2 rounded-md font-medium transition-colors"
                            >
                                {loading ? 'Scheduling...' : 'Schedule Padharamani'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Add Padharamani Page (full form)
        const AddPage = ({ onPageChange }) => {
            const [formData, setFormData] = useState({
                date: '',
                beginningTime: '',
                endingTime: '',
                name: '',
                address: '',
                city: '',
                email: '',
                phone: '',
                transportVolunteer: '',
                volunteerNumber: '',
                comments: '',
                zoneCoordinator: '',
                zoneCoordinatorPhone: ''
            });
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState(false);
            const [error, setError] = useState(null);

            // Auto-populate end time when beginning time changes
            const handleBeginningTimeChange = (value) => {
                setFormData(prev => {
                    const newFormData = { ...prev, beginningTime: value };
                    
                    if (value) {
                        // Add 30 minutes to beginning time
                        const [hours, minutes] = value.split(':');
                        const beginTime = new Date();
                        beginTime.setHours(parseInt(hours), parseInt(minutes));
                        beginTime.setMinutes(beginTime.getMinutes() + 30);
                        
                        const endHours = beginTime.getHours().toString().padStart(2, '0');
                        const endMinutes = beginTime.getMinutes().toString().padStart(2, '0');
                        newFormData.endingTime = `${endHours}:${endMinutes}`;
                    }
                    
                    return newFormData;
                });
            };

            const handleSubmit = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    await api.post('/padharamanis', formData);
                    
                    setSuccess(true);
                    
                    // Redirect to upcoming page after 2 seconds
                    setTimeout(() => {
                        onPageChange('upcoming');
                    }, 2000);
                    
                } catch (err) {
                    setError('Failed to add padharamani');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-6">Add Padharamani</h2>
                    
                    {success && (
                        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                            Padharamani added successfully and synced to Google Calendar!
                        </div>
                    )}
                    
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                            {error}
                        </div>
                    )}
                    
                    <div className="bg-white rounded-lg card-shadow p-4 sm:p-6">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                            <FormInput
                                label="Date"
                                type="date"
                                value={formData.date}
                                onChange={(value) => setFormData({...formData, date: value})}
                            />
                            <FormInput
                                label="Beginning Time"
                                type="time"
                                value={formData.beginningTime}
                                onChange={handleBeginningTimeChange}
                            />
                            <FormInput
                                label="Ending Time"
                                type="time"
                                value={formData.endingTime}
                                onChange={(value) => setFormData({...formData, endingTime: value})}
                            />
                            <FormInput
                                label="Name"
                                value={formData.name}
                                onChange={(value) => setFormData({...formData, name: value})}
                            />
                            <FormInput
                                label="Address"
                                value={formData.address}
                                onChange={(value) => setFormData({...formData, address: value})}
                            />
                            <FormInput
                                label="City"
                                value={formData.city}
                                onChange={(value) => setFormData({...formData, city: value})}
                            />
                            <FormInput
                                label="Email"
                                type="email"
                                value={formData.email}
                                onChange={(value) => setFormData({...formData, email: value})}
                            />
                            <FormInput
                                label="Phone"
                                type="tel"
                                value={formData.phone}
                                onChange={(value) => setFormData({...formData, phone: value})}
                            />
                            <FormInput
                                label="Transport Volunteer"
                                value={formData.transportVolunteer}
                                onChange={(value) => setFormData({...formData, transportVolunteer: value})}
                            />
                            <FormInput
                                label="Transport Volunteer's Phone"
                                type="tel"
                                value={formData.volunteerNumber}
                                onChange={(value) => setFormData({...formData, volunteerNumber: value})}
                            />
                            <FormInput
                                label="Zone Coordinator"
                                value={formData.zoneCoordinator}
                                onChange={(value) => setFormData({...formData, zoneCoordinator: value})}
                            />
                            <FormInput
                                label="Zone Coordinator's Phone"
                                type="tel"
                                value={formData.zoneCoordinatorPhone}
                                onChange={(value) => setFormData({...formData, zoneCoordinatorPhone: value})}
                            />
                        </div>
                        
                        <div className="mt-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Comments
                            </label>
                            <textarea
                                value={formData.comments}
                                onChange={(e) => setFormData({...formData, comments: e.target.value})}
                                rows={3}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 mobile-input"
                            />
                        </div>
                        
                        <div className="mt-6">
                            <button
                                onClick={handleSubmit}
                                disabled={loading}
                                className="w-full bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 text-white px-6 py-2 rounded-md font-medium transition-colors mobile-button"
                            >
                                {loading ? 'Adding...' : 'Add Padharamani'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Settings/More Page
        const SettingsPage = ({ user, onLogout }) => {
            const [showTelegram, setShowTelegram] = useState(false);
            const [showUserManagement, setShowUserManagement] = useState(false);
            const [showBackupManagement, setShowBackupManagement] = useState(false);
            const [users, setUsers] = useState([]);
            const [newUserForm, setNewUserForm] = useState({ email: '', password: '', name: '', isAdmin: false });
            const [loading, setLoading] = useState(false);
            const [backups, setBackups] = useState([]);
            const [backupStats, setBackupStats] = useState(null);

            const loadUsers = async () => {
                if (!user?.isAdmin) return;
                try {
                    const response = await api.get('/auth/users');
                    setUsers(response.users);
                } catch (error) {
                    console.error('Failed to load users:', error);
                }
            };

            const createUser = async () => {
                try {
                    setLoading(true);
                    await api.post('/auth/users', newUserForm);
                    setNewUserForm({ email: '', password: '', name: '', isAdmin: false });
                    await loadUsers();
                    alert('User created successfully');
                } catch (error) {
                    alert('Failed to create user: ' + (error.message || 'Unknown error'));
                } finally {
                    setLoading(false);
                }
            };

            const approveUser = async (email) => {
                try {
                    await api.post(`/auth/approve/${encodeURIComponent(email)}`);
                    await loadUsers();
                    alert('User approved successfully');
                } catch (error) {
                    alert('Failed to approve user');
                }
            };

            const deleteUser = async (email) => {
                if (!confirm('Are you sure you want to delete this user?')) return;
                try {
                    await api.delete(`/auth/users/${encodeURIComponent(email)}`);
                    await loadUsers();
                    alert('User deleted successfully');
                } catch (error) {
                    alert('Failed to delete user: ' + (error.message || 'Unknown error'));
                }
            };

            React.useEffect(() => {
                if (showUserManagement && user?.isAdmin) {
                    loadUsers();
                }
            }, [showUserManagement]);

            // Backup management functions
            const loadBackups = async () => {
                if (!user?.isAdmin) return;
                try {
                    console.log('📋 Loading backups...');
                    const response = await api.get('/backup/list');
                    setBackups(response.data || []);
                    console.log('✅ Backups loaded:', response.data?.length || 0);
                } catch (error) {
                    console.error('❌ Failed to load backups:', error);
                    setBackups([]);
                }
            };

            const loadBackupStats = async () => {
                if (!user?.isAdmin) return;
                try {
                    console.log('📊 Loading backup stats...');
                    const response = await api.get('/backup/stats');
                    setBackupStats(response.data);
                    console.log('✅ Backup stats loaded');
                } catch (error) {
                    console.error('❌ Failed to load backup stats:', error);
                }
            };

            const createManualBackup = async () => {
                if (!user?.isAdmin) return;
                try {
                    setLoading(true);
                    console.log('🔄 Creating manual backup...');
                    const response = await api.post('/backup/create');
                    console.log('✅ Manual backup created:', response.data);
                    await loadBackups();
                    await loadBackupStats();
                    alert('Backup created successfully: ' + response.data.filename);
                } catch (error) {
                    console.error('❌ Manual backup failed:', error);
                    alert('Failed to create backup: ' + (error.message || 'Unknown error'));
                } finally {
                    setLoading(false);
                }
            };

            const restoreBackup = async (filename) => {
                if (!user?.isAdmin) return;
                if (!confirm(`Are you sure you want to restore from backup: ${filename}?\n\nThis will replace all current data with the backup data. A backup of current data will be created first.`)) return;
                
                try {
                    setLoading(true);
                    console.log('🔄 Restoring backup:', filename);
                    const response = await api.post('/backup/restore', { filename });
                    console.log('✅ Backup restored:', response.data);
                    await loadBackups();
                    await loadBackupStats();
                    alert('Backup restored successfully. Please refresh the page to see the restored data.');
                } catch (error) {
                    console.error('❌ Backup restore failed:', error);
                    alert('Failed to restore backup: ' + (error.message || 'Unknown error'));
                } finally {
                    setLoading(false);
                }
            };

            const downloadBackup = async (filename) => {
                if (!user?.isAdmin) return;
                try {
                    console.log('📥 Downloading backup:', filename);
                    window.open(`/backup/download/${encodeURIComponent(filename)}`, '_blank');
                } catch (error) {
                    console.error('❌ Failed to download backup:', error);
                    alert('Failed to download backup');
                }
            };

            React.useEffect(() => {
                if (showBackupManagement && user?.isAdmin) {
                    loadBackups();
                    loadBackupStats();
                }
            }, [showBackupManagement]);

            const TelegramInfo = () => (
                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                    <div className="flex items-center gap-3 mb-4">
                        <svg className="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                        </svg>
                        <h3 className="text-xl font-semibold">Sant Padharamani Telegram</h3>
                    </div>
                    <p className="mb-4 text-blue-100">
                        Join our Telegram channel for updates, notifications, and community discussions about Sant Padharamani services.
                    </p>
                    <div className="space-y-3">
                        <button
                            onClick={() => window.open('https://t.me/santpadharamani', '_blank')}
                            className="telegram-button w-full justify-center"
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                            Join Channel
                        </button>
                        <p className="text-xs text-blue-200 text-center">
                            Get instant updates about padharamani schedules and announcements
                        </p>
                    </div>
                </div>
            );

            return (
                <div className="scroll-container">
                    <h2 className="text-2xl font-bold text-gray-900 mb-6">Settings & More</h2>
                    
                    {/* User Info */}
                    {user && (
                        <div className="bg-white rounded-lg card-shadow p-6 mb-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-3">Account</h3>
                            <div className="space-y-2">
                                <p className="text-sm text-gray-600">
                                    <span className="font-medium">Name:</span> {user.name}
                                </p>
                                <p className="text-sm text-gray-600">
                                    <span className="font-medium">Email:</span> {user.email}
                                </p>
                            </div>
                        </div>
                    )}
                    
                    {/* Quick Actions */}
                    <div className="bg-white rounded-lg card-shadow p-6 mb-6">
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                        <div className="space-y-3">
                            <button
                                onClick={() => setShowTelegram(!showTelegram)}
                                className="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-md font-medium transition-colors mobile-button flex items-center justify-between"
                            >
                                <div className="flex items-center gap-2">
                                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                    </svg>
                                    <span>Telegram Info</span>
                                </div>
                                <svg className={`w-4 h-4 transition-transform ${showTelegram ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            
                            <button
                                onClick={() => window.open('/auth/schedule-public', '_blank')}
                                className="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-md font-medium transition-colors mobile-button flex items-center gap-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                <span>Public Schedule Link</span>
                            </button>
                            
                            {user && user.isAdmin && (
                                <>
                                    <button
                                        onClick={() => setShowUserManagement(true)}
                                        className="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-md font-medium transition-colors mobile-button flex items-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                                        </svg>
                                        <span>User Management</span>
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowBackupManagement(true)}
                                        className="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-3 rounded-md font-medium transition-colors mobile-button flex items-center gap-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                        </svg>
                                        <span>Backup & Restore</span>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    
                    {/* Telegram Info Expandable */}
                    {showTelegram && (
                        <div className="mb-6">
                            <TelegramInfo />
                        </div>
                    )}
                    
                    {/* App Info */}
                    <div className="bg-white rounded-lg card-shadow p-6 mb-6">
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">App Information</h3>
                        <div className="space-y-2 text-sm text-gray-600">
                            <p><span className="font-medium">Version:</span> 1.0.0</p>
                            <p><span className="font-medium">Last Updated:</span> {new Date().toLocaleDateString()}</p>
                            <p className="mt-3 text-xs text-gray-500">
                                This is a mobile-optimized Progressive Web App for managing Sant Padharamani services.
                            </p>
                        </div>
                    </div>
                    
                    {/* User Management Modal */}
                    {showUserManagement && user?.isAdmin && (
                        <div className="bg-white rounded-lg card-shadow p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-900">User Management</h3>
                                <button
                                    onClick={() => setShowUserManagement(false)}
                                    className="text-gray-500 hover:text-gray-700"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            {/* Create User Form */}
                            <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 className="font-medium mb-3">Create New User</h4>
                                <div className="space-y-3">
                                    <input
                                        type="email"
                                        placeholder="Email"
                                        value={newUserForm.email}
                                        onChange={(e) => setNewUserForm({...newUserForm, email: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md mobile-input"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Name"
                                        value={newUserForm.name}
                                        onChange={(e) => setNewUserForm({...newUserForm, name: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md mobile-input"
                                    />
                                    <input
                                        type="password"
                                        placeholder="Password"
                                        value={newUserForm.password}
                                        onChange={(e) => setNewUserForm({...newUserForm, password: e.target.value})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md mobile-input"
                                    />
                                    <label className="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            checked={newUserForm.isAdmin}
                                            onChange={(e) => setNewUserForm({...newUserForm, isAdmin: e.target.checked})}
                                        />
                                        <span className="text-sm">Admin User</span>
                                    </label>
                                    <button
                                        onClick={createUser}
                                        disabled={loading || !newUserForm.email || !newUserForm.name || !newUserForm.password}
                                        className="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white px-4 py-2 rounded-md mobile-button"
                                    >
                                        {loading ? 'Creating...' : 'Create User'}
                                    </button>
                                </div>
                            </div>
                            
                            {/* Users List */}
                            <div className="space-y-2">
                                <h4 className="font-medium">All Users</h4>
                                {users.map(user => (
                                    <div key={user.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div className="flex-1">
                                            <p className="font-medium text-sm">{user.name}</p>
                                            <p className="text-xs text-gray-600">{user.email}</p>
                                            <div className="flex gap-2 mt-1">
                                                {user.isAdmin && <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Admin</span>}
                                                {user.isTelegramUser && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Telegram</span>}
                                                {user.isApproved ? (
                                                    <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Approved</span>
                                                ) : (
                                                    <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Pending</span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex gap-1">
                                            {!user.isApproved && (
                                                <button
                                                    onClick={() => approveUser(user.email)}
                                                    className="text-xs bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded"
                                                >
                                                    Approve
                                                </button>
                                            )}
                                            <button
                                                onClick={() => deleteUser(user.email)}
                                                className="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Backup Management Modal */}
                    {showBackupManagement && user?.isAdmin && (
                        <div className="bg-white rounded-lg card-shadow p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-900">Backup & Restore Management</h3>
                                <button
                                    onClick={() => setShowBackupManagement(false)}
                                    className="text-gray-500 hover:text-gray-700"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            {/* Backup Stats */}
                            {backupStats && (
                                <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                                    <h4 className="font-medium mb-3 text-indigo-900">Backup Statistics</h4>
                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                        <div className="text-indigo-700">
                                            <span className="font-medium">Total Backups:</span> {backupStats.backupStats?.totalBackups || 0}
                                        </div>
                                        <div className="text-indigo-700">
                                            <span className="font-medium">Local:</span> {backupStats.backupStats?.localBackups || 0}
                                        </div>
                                        <div className="text-indigo-700">
                                            <span className="font-medium">Cloud:</span> {backupStats.backupStats?.cloudBackups || 0}
                                        </div>
                                        <div className="text-indigo-700">
                                            <span className="font-medium">Total Size:</span> {backupStats.backupStats?.totalSize ? (backupStats.backupStats.totalSize / 1024).toFixed(1) + ' KB' : '0 KB'}
                                        </div>
                                    </div>
                                    {backupStats.schedulerStatus && (
                                        <div className="mt-3 pt-3 border-t border-indigo-200">
                                            <div className="text-xs text-indigo-600">
                                                <div><span className="font-medium">Scheduler:</span> {backupStats.schedulerStatus.initialized ? '✅ Active' : '❌ Inactive'}</div>
                                                {backupStats.schedulerStatus.activeJobs?.map(job => (
                                                    <div key={job.name}><span className="font-medium">{job.name}:</span> {job.running ? '🟢 Running' : '🔴 Stopped'} - Next: {job.nextDate ? new Date(job.nextDate).toLocaleString() : 'N/A'}</div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Create Backup Section */}
                            <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 className="font-medium mb-3">Create Manual Backup</h4>
                                <p className="text-sm text-gray-600 mb-3">
                                    Create an immediate backup of all data including padharamani records, users, and settings.
                                </p>
                                <button
                                    onClick={createManualBackup}
                                    disabled={loading}
                                    className="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white px-4 py-2 rounded-md mobile-button flex items-center justify-center gap-2"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    {loading ? 'Creating Backup...' : 'Create Backup Now'}
                                </button>
                            </div>
                            
                            {/* Available Backups List */}
                            <div className="space-y-2">
                                <div className="flex items-center justify-between">
                                    <h4 className="font-medium">Available Backups</h4>
                                    <button
                                        onClick={() => {loadBackups(); loadBackupStats();}}
                                        className="text-sm text-blue-500 hover:text-blue-600"
                                    >
                                        🔄 Refresh
                                    </button>
                                </div>
                                {backups.length === 0 ? (
                                    <p className="text-sm text-gray-500 italic">No backups available</p>
                                ) : (
                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                        {backups.map(backup => (
                                            <div key={backup.filename} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-medium text-sm truncate">{backup.filename}</p>
                                                    <div className="text-xs text-gray-600 mt-1">
                                                        <div>📅 {new Date(backup.created).toLocaleString()}</div>
                                                        <div>📍 {backup.location} • 💾 {(backup.size / 1024).toFixed(1)} KB</div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-1 ml-2">
                                                    <button
                                                        onClick={() => downloadBackup(backup.filename)}
                                                        className="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded"
                                                        title="Download"
                                                    >
                                                        📥
                                                    </button>
                                                    <button
                                                        onClick={() => restoreBackup(backup.filename)}
                                                        disabled={loading}
                                                        className="text-xs bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 text-white px-2 py-1 rounded"
                                                        title="Restore"
                                                    >
                                                        🔄
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* Logout */}
                    <div className="bg-white rounded-lg card-shadow p-6">
                        <button
                            onClick={onLogout}
                            className="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-md font-medium transition-colors mobile-button flex items-center justify-center gap-2"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            <span>Sign Out</span>
                        </button>
                    </div>
                </div>
            );
        };

        // Padharamani Requests Page
        const RequestsPage = ({ onEdit }) => {
            const [scheduledRequests, setScheduledRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                loadScheduledRequests();
            }, []);

            const loadScheduledRequests = async () => {
                try {
                    setLoading(true);
                    setError(null); // Clear previous errors
                    const data = await api.get('/padharamanis/scheduled');
                    setScheduledRequests(data);
                } catch (err) {
                    console.error('❌ Failed to load scheduled requests:', err);
                    if (err.message === 'Authentication required') {
                        // Don't set error state, let redirect handle authentication
                        return;
                    }
                    setError('Failed to load scheduled requests');
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="flex justify-center items-center h-64">
                        <div className="text-lg">Loading...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        {error}
                    </div>
                );
            }

            return (
                <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-6">Scheduled Requests</h2>
                    <div className="mb-4 text-sm text-gray-600">
                        <p>These are requests submitted through the public form that need date and time scheduling.</p>
                        <p className="mt-1">Edit each request to add complete details and move it to upcoming padharamani.</p>
                    </div>
                    
                    {scheduledRequests.length === 0 ? (
                        <div className="text-center py-8">
                            <p className="text-gray-500 text-lg">No pending schedule requests</p>
                            <div className="mt-4">
                                <p className="text-sm text-gray-400">Share this link for public scheduling:</p>
                                <p className="text-sm text-blue-600 font-mono bg-gray-100 p-2 rounded mt-2">
                                    {window.location.origin}/auth/schedule-public
                                </p>
                            </div>
                        </div>
                    ) : (
                        <div>
                            <div className="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p className="text-sm text-blue-800">
                                    <strong>Public scheduling link:</strong> 
                                    <span className="font-mono ml-2 bg-blue-100 px-2 py-1 rounded">
                                        {window.location.origin}/auth/schedule-public
                                    </span>
                                </p>
                            </div>
                            
                            {scheduledRequests.map((request, index) => (
                                <PadharamaniCard
                                    key={`scheduled-${request.id || index}`}
                                    padharamani={request}
                                    onEdit={onEdit}
                                    showActions={true}
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Edit Modal Component
        const EditModal = ({ padharamani, onClose, onSave }) => {
            const [formData, setFormData] = useState(padharamani || {});
            const [loading, setLoading] = useState(false);

            // Auto-populate end time when beginning time changes
            const handleBeginningTimeChange = (value) => {
                const newFormData = { ...formData, beginningTime: value };
                
                if (value && (!formData.endingTime || formData.endingTime === '')) {
                    // Add 30 minutes to beginning time
                    const [hours, minutes] = value.split(':');
                    const beginTime = new Date();
                    beginTime.setHours(parseInt(hours), parseInt(minutes));
                    beginTime.setMinutes(beginTime.getMinutes() + 30);
                    
                    const endHours = beginTime.getHours().toString().padStart(2, '0');
                    const endMinutes = beginTime.getMinutes().toString().padStart(2, '0');
                    newFormData.endingTime = `${endHours}:${endMinutes}`;
                }
                
                setFormData(newFormData);
            };

            const handleSave = async () => {
                try {
                    setLoading(true);
                    await onSave(formData);
                    onClose();
                } catch (err) {
                    console.error('Failed to save:', err);
                } finally {
                    setLoading(false);
                }
            };

            if (!padharamani) return null;

            return (
                <div className="mobile-modal">
                    <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto m-4">
                        <div className="p-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Edit Padharamani</h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <FormInput
                                    label="Date"
                                    type="date"
                                    value={formData.date || ''}
                                    onChange={(value) => setFormData({...formData, date: value})}
                                />
                                <FormInput
                                    label="Beginning Time"
                                    type="time"
                                    value={formData.beginningTime || ''}
                                    onChange={handleBeginningTimeChange}
                                />
                                <FormInput
                                    label="Ending Time"
                                    type="time"
                                    value={formData.endingTime || ''}
                                    onChange={(value) => setFormData({...formData, endingTime: value})}
                                />
                                <FormInput
                                    label="Name"
                                    value={formData.name || ''}
                                    onChange={(value) => setFormData({...formData, name: value})}
                                />
                                <FormInput
                                    label="Address"
                                    value={formData.address || ''}
                                    onChange={(value) => setFormData({...formData, address: value})}
                                />
                                <FormInput
                                    label="City"
                                    value={formData.city || ''}
                                    onChange={(value) => setFormData({...formData, city: value})}
                                />
                                <FormInput
                                    label="Email"
                                    type="email"
                                    value={formData.email || ''}
                                    onChange={(value) => setFormData({...formData, email: value})}
                                />
                                <FormInput
                                    label="Phone"
                                    type="tel"
                                    value={formData.phone || ''}
                                    onChange={(value) => setFormData({...formData, phone: value})}
                                />
                                <FormInput
                                    label="Transport Volunteer"
                                    value={formData.transportVolunteer || ''}
                                    onChange={(value) => setFormData({...formData, transportVolunteer: value})}
                                />
                                <FormInput
                                    label="Transport Volunteer's Phone"
                                    type="tel"
                                    value={formData.volunteerNumber || ''}
                                    onChange={(value) => setFormData({...formData, volunteerNumber: value})}
                                />
                                <FormInput
                                    label="Zone Coordinator"
                                    value={formData.zoneCoordinator || ''}
                                    onChange={(value) => setFormData({...formData, zoneCoordinator: value})}
                                />
                                <FormInput
                                    label="Zone Coordinator's Phone"
                                    type="tel"
                                    value={formData.zoneCoordinatorPhone || ''}
                                    onChange={(value) => setFormData({...formData, zoneCoordinatorPhone: value})}
                                />
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Comments
                                </label>
                                <textarea
                                    value={formData.comments || ''}
                                    onChange={(e) => setFormData({...formData, comments: e.target.value})}
                                    rows={3}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 mobile-input"
                                />
                            </div>
                            
                            <div className="flex flex-col sm:flex-row gap-3">
                                <button
                                    onClick={handleSave}
                                    disabled={loading}
                                    className="flex-1 bg-primary-500 hover:bg-primary-600 disabled:bg-gray-300 text-white px-6 py-2 rounded-md font-medium transition-colors mobile-button"
                                >
                                    {loading ? 'Saving...' : 'Save Changes'}
                                </button>
                                <button
                                    onClick={onClose}
                                    disabled={loading}
                                    className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md font-medium transition-colors mobile-button"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            console.log('🏁 App component initializing...');
            const [currentPage, setCurrentPage] = useState('upcoming');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [editingPadharamani, setEditingPadharamani] = useState(null);

            useEffect(() => {
                console.log('📱 App useEffect hook triggered, starting initialization...');
                // Initialize Telegram WebApp
                console.log('🔄 Initializing Telegram WebApp...');
                const tg = initTelegramWebApp();
                
                // Check authentication
                console.log('🔐 Starting authentication check...');
                checkAuthStatus();
            }, []);

            const checkAuthStatus = async () => {
                console.log('🔍 checkAuthStatus started...');
                try {
                    // Try Telegram authentication first
                    console.log('📱 Attempting Telegram authentication...');
                    const telegramUser = getTelegramUser();
                    
                    if (telegramUser) {
                        console.log('✅ Telegram user found, attempting server authentication...');
                        // Authenticate with Telegram data
                        const response = await fetch('/auth/telegram', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ telegramUser })
                        });
                        
                        console.log('📡 Telegram auth response:', {
                            status: response.status,
                            statusText: response.statusText,
                            ok: response.ok
                        });
                        
                        if (response.ok) {
                            const userData = await response.json();
                            console.log('✅ Telegram authentication successful:', userData);
                            const user = {
                                id: telegramUser.id,
                                name: `${telegramUser.first_name} ${telegramUser.last_name || ''}`.trim(),
                                email: telegramUser.username || `user_${telegramUser.id}@telegram`,
                                telegramId: telegramUser.id
                            };
                            console.log('👤 Setting user state:', user);
                            setUser(user);
                            setLoading(false);
                            return;
                        } else {
                            console.log('❌ Telegram authentication failed, falling back to regular auth');
                        }
                    } else {
                        console.log('❌ No Telegram user, trying regular authentication...');
                    }
                    
                    // Fallback to regular authentication
                    console.log('🔐 Attempting regular authentication...');
                    const response = await fetch('/auth/me', {
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        }
                    });
                    
                    console.log('📡 Regular auth response:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });
                    
                    if (!response.ok) {
                        throw new Error('Not authenticated');
                    }
                    
                    const userData = await response.json();
                    console.log('✅ Regular authentication successful:', userData);
                    setUser(userData);
                } catch (err) {
                    console.error('❌ Authentication failed:', err);
                    // For Telegram Mini App, show simple login instead of redirect
                    if (window.Telegram?.WebApp) {
                        console.log('📱 Telegram WebApp detected, staying in app for login');
                        setLoading(false);
                        // Show in-app login for Telegram
                    } else {
                        console.log('🌐 Regular browser, redirecting to login page');
                        window.location.href = '/auth/login-page';
                    }
                } finally {
                    console.log('🏁 Authentication check completed, setting loading to false');
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                try {
                    await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        }
                    });
                    localStorage.removeItem('token');
                    window.location.href = '/auth/login-page';
                } catch (err) {
                    console.error('Logout error:', err);
                    localStorage.removeItem('token');
                    window.location.href = '/auth/login-page';
                }
            };

            const handleEdit = (padharamani) => {
                setEditingPadharamani(padharamani);
            };

            const handleSaveEdit = async (updatedPadharamani) => {
                try {
                    await api.put(`/padharamanis/${updatedPadharamani.id || updatedPadharamani.date}`, updatedPadharamani);
                    
                    // If this item now has a date, move it to appropriate section
                    if (updatedPadharamani.date) {
                        const today = new Date().toISOString().split('T')[0];
                        if (updatedPadharamani.date >= today) {
                            // Future or today - move to upcoming
                            setCurrentPage('upcoming');
                        } else {
                            // Past date - move to archived
                            setCurrentPage('archived');
                        }
                    } else {
                        // No date - stays in requests
                        setCurrentPage('requests');
                    }
                    
                    window.location.reload();
                } catch (err) {
                    throw err;
                }
            };

            const handleCancel = async (padharamani) => {
                if (confirm('Are you sure you want to cancel this padharamani?')) {
                    try {
                        await api.put(`/padharamanis/${padharamani.id || padharamani.date}`, {
                            ...padharamani,
                            status: 'Canceled'
                        });
                        // Canceled items should show in archived
                        setCurrentPage('archived');
                        window.location.reload();
                    } catch (err) {
                        alert('Failed to cancel padharamani');
                        console.error(err);
                    }
                }
            };

            const handleActivate = async (padharamani) => {
                if (confirm('Are you sure you want to activate this padharamani?')) {
                    try {
                        await api.put(`/padharamanis/${padharamani.id || padharamani.date}`, {
                            ...padharamani,
                            status: 'Scheduled'
                        });
                        
                        // Move to appropriate page based on date
                        if (padharamani.date) {
                            const today = new Date().toISOString().split('T')[0];
                            if (padharamani.date >= today) {
                                setCurrentPage('upcoming');
                            } else {
                                setCurrentPage('archived');
                            }
                        } else {
                            setCurrentPage('scheduled');
                        }
                        
                        window.location.reload();
                    } catch (err) {
                        alert('Failed to activate padharamani');
                        console.error(err);
                    }
                }
            };

            if (loading) {
                return (
                    <div className="flex justify-center items-center min-h-screen">
                        <div className="text-xl">Loading...</div>
                    </div>
                );
            }

            const renderCurrentPage = () => {
                console.log('🎨 Rendering page:', currentPage);
                switch (currentPage) {
                    case 'upcoming':
                        console.log('📅 Rendering UpcomingPage');
                        return <UpcomingPage onEdit={handleEdit} onCancel={handleCancel} onActivate={handleActivate} />;
                    case 'scheduled':
                        console.log('⏰ Rendering ScheduledPage (RequestsPage)');
                        return <RequestsPage onEdit={handleEdit} />;
                    case 'archived':
                        console.log('📦 Rendering ArchivedPage');
                        return <ArchivedPage onActivate={handleActivate} />;
                    case 'add':
                        console.log('➕ Rendering AddPage');
                        return <AddPage onPageChange={setCurrentPage} />;
                    case 'settings':
                        console.log('⚙️ Rendering SettingsPage');
                        return <SettingsPage user={user} onLogout={handleLogout} />;
                    default:
                        console.log('🏠 Rendering default UpcomingPage');
                        return <UpcomingPage onEdit={handleEdit} onCancel={handleCancel} onActivate={handleActivate} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 telegram-mini-app">
                    <Navigation 
                        currentPage={currentPage}
                        onPageChange={setCurrentPage}
                        user={user}
                        onLogout={handleLogout}
                    />
                    
                    <main className="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                        {renderCurrentPage()}
                    </main>
                    
                    {editingPadharamani && (
                        <EditModal
                            padharamani={editingPadharamani}
                            onClose={() => setEditingPadharamani(null)}
                            onSave={handleSaveEdit}
                        />
                    )}
                </div>
            );
        };

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after 10 seconds if not already installed
            setTimeout(() => {
                if (deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                    const installDiv = document.createElement('div');
                    installDiv.className = 'install-prompt';
                    installDiv.style.display = 'block';
                    installDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span>Install this app for better experience</span>
                            <div class="ml-4 space-x-2">
                                <button id="install-btn" class="bg-white text-orange-600 px-3 py-1 rounded text-sm font-medium hover:bg-gray-100">
                                    Install
                                </button>
                                <button id="dismiss-btn" class="text-orange-200 hover:text-white text-sm">
                                    ×
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(installDiv);
                    
                    document.getElementById('install-btn').addEventListener('click', () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then((result) => {
                                deferredPrompt = null;
                                installDiv.remove();
                            });
                        }
                    });
                    
                    document.getElementById('dismiss-btn').addEventListener('click', () => {
                        installDiv.remove();
                        deferredPrompt = null;
                    });
                }
            }, 10000);
        });

        // Render the app
        console.log('🚀 Starting React app render...');
        try {
            ReactDOM.render(<App />, document.getElementById('root'));
            console.log('✅ React app rendered successfully!');
        } catch (error) {
            console.error('❌ Failed to render React app:', error);
        }
    </script>
</body>
</html>